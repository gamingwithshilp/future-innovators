#include <Servo.h>
#include <DHT.h>

// --- Servo Motors ---
Servo servoX;  // For X-axis (e.g. steering)
Servo servoY;  // For Y-axis (e.g. arm)

// --- Joystick Pins ---
const int joyX = A0;
const int joyY = A1;
const int joyBtn = 2;

// --- DC Motor Pins ---
const int in1 = 12;
const int in2 = 13;
const int enA = 14;

// --- Output Indicators ---
const int ledPin = 8;

// --- Dust Sensor ---
const int dustPin = A2;
const int ledPower = 3; // Dust sensor LED control pin
int samplingTime = 280;
int deltaTime = 40;
int sleepTime = 9680;

// --- DHT11 Sensor ---
#define DHTPIN 4
#define DHTTYPE DHT11
DHT dht(DHTPIN, DHTTYPE);

// --- Gas Sensor ---
const int gasSensorPin = A3;

void setup() {
  // Joystick button & outputs
  pinMode(joyBtn, INPUT_PULLUP);
  pinMode(ledPin, OUTPUT);

  // DC Motor setup
  pinMode(in1, OUTPUT);
  pinMode(in2, OUTPUT);
  pinMode(enA, OUTPUT);

  // Dust sensor LED control
  pinMode(ledPower, OUTPUT);

  // Start peripherals
  servoX.attach(9);
  servoY.attach(10);
  dht.begin();

  Serial.begin(9600);
}

void loop() {
  // ------------------ Joystick ------------------
  int xVal = analogRead(joyX);
  int yVal = analogRead(joyY);
  int btnState = digitalRead(joyBtn);

  // --- Servo Control ---
  int angleX = map(xVal, 0, 1023, 10, 170);
  int angleY = map(yVal, 0, 1023, 10, 170);
  servoX.write(angleX);
  servoY.write(angleY);

  // --- DC Motor (based on Y-axis) ---
  if (yVal > 600) {
    digitalWrite(in1, HIGH);
    digitalWrite(in2, LOW);
    analogWrite(enA, map(yVal, 600, 1023, 0, 255));
  } else if (yVal < 400) {
    digitalWrite(in1, LOW);
    digitalWrite(in2, HIGH);
    analogWrite(enA, map(400 - yVal, 0, 400, 0, 255));
  } else {
    digitalWrite(in1, LOW);
    digitalWrite(in2, LOW);
  }

  // --- LED on Button Press ---
  digitalWrite(ledPin, btnState == LOW ? HIGH : LOW);

  // ------------------ Dust Sensor ------------------
  digitalWrite(ledPower, LOW);
  delayMicroseconds(samplingTime);
  int voMeasured = analogRead(dustPin);
  delayMicroseconds(deltaTime);
  digitalWrite(ledPower, HIGH);
  delayMicroseconds(sleepTime);

  float voltage = voMeasured * (5.0 / 1024.0);
  float dustDensity = 170 * voltage - 0.1;

  // ------------------ DHT11 Sensor ------------------
  float temperature = dht.readTemperature();
  float humidity = dht.readHumidity();

  // ------------------ Gas Sensor ------------------
  int gasValue = analogRead(gasSensorPin);

  // ------------------ Serial Monitor Output ------------------
  Serial.println("---- Sensor Data ----");
  Serial.print("Dust Density: ");
  Serial.print(dustDensity);
  Serial.println(" ug/m3");

  Serial.print("Temperature: ");
  Serial.print(temperature);
  Serial.println(" Â°C");

  Serial.print("Humidity: ");
  Serial.print(humidity);
  Serial.println(" %");

  Serial.print("Gas Sensor: ");
  Serial.println(gasValue);

  Serial.println("----------------------\n");

  delay(2000); // Wait before next loop
}
